<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Просмотр и редактирование базы данных</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        select, button {
            margin: 10px 0;
            padding: 5px;
            font-size: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        tr:nth-child(even) {
            background-color: #fafafa;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            box-sizing: border-box;
            padding: 5px;
        }
        button.save-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        button.save-btn:hover {
            background-color: #218838;
        }
        button.add-row {
            margin: 10px 0;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 7px 15px;
            cursor: pointer;
        }
        button.add-row:hover {
            background-color: #0069d9;
        }
    </style>
</head>
<body>
<h1>Просмотр и редактирование базы данных</h1>
<select id="table-select">
    <option value="employees">Сотрудники</option>
    <option value="disciplines">Дисциплины</option>
    <option value="specialties">Специальности</option>
    <option value="departments">Отделы</option>
    <option value="phone_numbers">Телефонные номера</option>
    <option value="disciplines_and_specialties">Дисциплины и специальности</option>
    <option value="disciplines_and_employees">Дисциплины и сотрудники</option>
    <option value="employees_and_departments">Сотрудники и отделы</option>
</select>
<button onclick="loadTable()">Загрузить таблицу</button>
<button class="add-row" onclick="addRow()">Добавить запись</button>
<div id="table-data"></div>

<script>
    let currentTable = '';
    let tableData = [];

    async function loadTable() {
        currentTable = document.getElementById('table-select').value;
        const response = await fetch('http://195.133.18.211:3000/query', {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: `SELECT * FROM employees`,
            })
        })
        tableData = await response.json();
        renderTable();
    }

    function renderTable() {
        const tableDiv = document.getElementById('table-data');
        tableDiv.innerHTML = '';

        if (tableData.length > 0) {
            const tableElem = document.createElement('table');
            const headers = Object.keys(tableData[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.innerText = header;
                headerRow.appendChild(th);
            });
            const thActions = document.createElement('th');
            thActions.innerText = 'Действия';
            headerRow.appendChild(thActions);
            tableElem.appendChild(headerRow);

            tableData.forEach((row, index) => {
                const rowElem = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = row[header];
                    input.dataset.field = header;
                    input.dataset.index = index;
                    input.onchange = (e) => {
                        tableData[index][header] = e.target.value;
                    };
                    td.appendChild(input);
                    rowElem.appendChild(td);
                });
                const tdActions = document.createElement('td');
                const saveBtn = document.createElement('button');
                saveBtn.innerText = 'Сохранить';
                saveBtn.className = 'save-btn';
                saveBtn.onclick = () => saveRow(index);
                tdActions.appendChild(saveBtn);
                rowElem.appendChild(tdActions);
                tableElem.appendChild(rowElem);
            });
            tableDiv.appendChild(tableElem);
        } else {
            tableDiv.innerText = 'Данные отсутствуют.';
        }
    }

    function addRow() {
        if (currentTable === '') {
            alert('Пожалуйста, выберите таблицу.');
            return;
        }
        const newRow = {};
        const headers = tableData.length > 0 ? Object.keys(tableData[0]) : [];
        headers.forEach(header => {
            newRow[header] = '';
        });
        tableData.push(newRow);
        renderTable();
    }

    async function saveRow(index) {
        const row = tableData[index];
        const response = await fetch(`/api/${currentTable}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: `INSERT INTO employees (
                    job_title,
                    full_name,
                    DOB,
                    hiring_date,
                    experience,
                    academic_degree,
                    education
                ) VALUES (
                 'Software Developer',
                 'John Doe',
                 '1990-05-15',
                 '2020-06-01',
                 '3 years 6 months',
                 'Master of Science',
                 'Computer Science');`,
            })
        });
        const result = await response.json();
        if (response.ok) {
            alert('Данные успешно сохранены.');
            await loadTable();
        } else {
            alert('Ошибка при сохранении данных: ' + result.error);
        }
    }
</script>
</body>
</html>